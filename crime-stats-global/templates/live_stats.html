<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Homicide Stats - {{ countries[selected_country] if selected_country in countries else selected_country }}</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 30px; background: #121212; color: #e0e0e0; }
    header { background: #1e1e1e; color: white; padding: 30px; text-align: center; border-radius: 20px; margin-bottom: 40px; }
    .stats-container { max-width: 1000px; margin: auto; }
    select, button { padding: 12px 20px; font-size: 16px; border-radius: 10px; border: 2px solid #444; background: #2a2a2a; color: white; margin-right: 10px; }
    button { cursor: pointer; background: #007bff; color: white; }
    .chart-container { height: 500px; margin-top: 30px; }
    .latest-stat { margin-top: 20px; font-size: 18px; }
  </style>
</head>
<body>
  <header>
    <h1>üî¥ Live Homicide Rates</h1>
    <p>Real-time data from World Bank API (2000-2024)</p>
  </header>

  <div class="stats-container">
    <div>
      <label for="countrySelect"><strong>üåç Select Country:</strong></label>
      <select id="countrySelect" onchange="updateChart()">
        {% for code, name in countries.items() %}
          <option value="{{ code }}" {% if code == selected_country %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
      <button onclick="window.location='/stats'">üìä Crime Stats</button>
      <button onclick="window.location='/'">üè† Home</button>
    </div>

    <div class="latest-stat">
      {% if chart is defined and chart.values %}
        Latest: {{ chart.values[-1]|default(0)|round(2) }} per 100k ({{ chart.years[-1]|default('N/A') }})
      {% else %}
        No data available
      {% endif %}
    </div>

    <div class="chart-container">
      <canvas id="homicideChart"></canvas>
    </div>
  </div>
  <div class="news-section">
  <h2>üì∞ Latest Telangana Crime News</h2>
  <ul id="newsList"></ul>
</div>

<script>
  async function fetchCrimeNews() {
    try {
      const res = await fetch('/api/telangana-crime-news');
      const data = await res.json();

      const newsList = document.getElementById('newsList');
      newsList.innerHTML = '';

      if(data.articles.length === 0){
        newsList.innerHTML = '<li>No news available</li>';
        return;
      }

      data.articles.forEach(article => {
        const li = document.createElement('li');
        li.innerHTML = `<a href="${article.url}" target="_blank">${article.title}</a> <small>(${article.source})</small>`;
        newsList.appendChild(li);
      });
    } catch (err) {
      console.error('Error fetching news:', err);
      document.getElementById('newsList').innerHTML = '<li>Error loading news</li>';
    }
  }

  document.addEventListener('DOMContentLoaded', fetchCrimeNews);
</script>


  <script id="chart-data" type="application/json">
    {{ chart | tojson | safe }}
  </script>

  <script>
    const initialChartData = JSON.parse(document.getElementById('chart-data').textContent || '{}');
    let currentChart;

    function createChart(data) {
      const ctx = document.getElementById('homicideChart').getContext('2d');
      if (currentChart) currentChart.destroy();

      if (!data.years || !data.values || data.years.length === 0) {
        ctx.font = '24px Segoe UI';
        ctx.fillStyle = '#888';
        ctx.textAlign = 'center';
        ctx.fillText('No data available for this country', ctx.canvas.width/2, ctx.canvas.height/2);
        return;
      }

      currentChart = new Chart(ctx, {
        type: 'line',
        data: { labels: data.years, datasets: [{ label: 'Homicides per 100k', data: data.values, borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.1)', borderWidth: 3, fill: true, tension: 0.4 }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
     

    
    function updateChart() {
      const countryCode = document.getElementById('countrySelect').value;
      fetch(`/live?country=${countryCode}`)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newDataEl = doc.getElementById('chart-data');
          if (newDataEl) createChart(JSON.parse(newDataEl.textContent));
        });
    }

    document.addEventListener('DOMContentLoaded', () => createChart(initialChartData));
  </script>
</body>
</html>
